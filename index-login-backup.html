<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模擬試験結果閲覧</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: #fafafa;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // 教員アカウント
        const teachers = [
            {
                id: 'teacher001',
                name: '田中先生',
                password: 'teacher123',
                role: 'teacher'
            },
            {
                id: 'admin',
                name: '管理者',
                password: 'admin123',
                role: 'teacher'
            }
        ];

        // 学生データ（パスワード付き + 問題詳細）
        const rawStudentScores = [
            {
                studentId: 'S001',
                studentName: '山田太郎',
                password: 'pass001', // デモ用パスワード
                required: 45,
                解剖学: 38,
                生理学: 42,
                運動学: 35,
                病理学: 40,
                衛生学: 36,
                リハビリ医学: 41,
                一般臨床: 44,
                外科学: 39,
                整形外科: 43,
                柔整理論: 40,
                // 問題詳細（例：必修の問題詳細）
                questionDetails: {
                    必修: [
                        { questionNumber: 1, userAnswer: 3, correctAnswer: 3, source: '第27回国試' },
                        { questionNumber: 2, userAnswer: 2, correctAnswer: 2, source: '第26回国試' },
                        { questionNumber: 3, userAnswer: 1, correctAnswer: 2, source: '第28回国試' },
                        { questionNumber: 4, userAnswer: 4, correctAnswer: 4, source: '過去問題集p.15' },
                        { questionNumber: 5, userAnswer: 2, correctAnswer: 2, source: '第25回国試' },
                    ],
                    解剖学: [
                        { questionNumber: 1, userAnswer: 3, correctAnswer: 3, source: '第27回国試' },
                        { questionNumber: 2, userAnswer: 2, correctAnswer: 1, source: '教科書p.203' },
                        { questionNumber: 3, userAnswer: 4, correctAnswer: 4, source: '第26回国試' },
                    ]
                }
            },
            {
                studentId: 'S002',
                studentName: '佐藤花子',
                password: 'pass002',
                required: 42,
                解剖学: 35,
                生理学: 38,
                運動学: 40,
                病理学: 37,
                衛生学: 39,
                リハビリ医学: 38,
                一般臨床: 41,
                外科学: 36,
                整形外科: 40,
                柔整理論: 38,
                questionDetails: {
                    必修: [
                        { questionNumber: 1, userAnswer: 3, correctAnswer: 3, source: '第27回国試' },
                        { questionNumber: 2, userAnswer: 1, correctAnswer: 2, source: '第26回国試' },
                    ]
                }
            },
            {
                studentId: 'S003',
                studentName: '鈴木一郎',
                password: 'pass003',
                required: 48,
                解剖学: 42,
                生理学: 45,
                運動学: 38,
                病理学: 43,
                questionDetails: {}
                衛生学: 40,
                リハビリ医学: 44,
                一般臨床: 46,
                外科学: 41,
                整形外科: 45,
                柔整理論: 43,
            },
            {
                studentId: 'S004',
                studentName: '田中美咲',
                password: 'pass004',
                required: 40,
                解剖学: 33,
                生理学: 36,
                運動学: 38,
                questionDetails: {}
                病理学: 35,
                衛生学: 37,
                リハビリ医学: 36,
                一般臨床: 39,
                外科学: 34,
                整形外科: 38,
                柔整理論: 36,
            },
            {
                studentId: 'S005',
                studentName: '高橋健',
                password: 'pass005',
                required: 46,
                解剖学: 40,
                生理学: 43,
                運動学: 36,
                病理学: 41,
                衛生学: 38,
                リハビリ医学: 42,
                一般臨床: 44,
                外科学: 39,
                questionDetails: {}
                整形外科: 42,
                柔整理論: 41,
            },
        ];

        const maxScores = {
            required: 50,
            解剖学: 50,
            生理学: 50,
            運動学: 50,
            病理学: 50,
            衛生学: 50,
            リハビリ医学: 50,
            一般臨床: 50,
            外科学: 50,
            整形外科: 50,
            柔整理論: 50,
        };

        const subjectNames = [
            '解剖学', '生理学', '運動学', '病理学', '衛生学',
            'リハビリ医学', '一般臨床', '外科学', '整形外科', '柔整理論'
        ];

        // ユーティリティ関数
        function calculateDeviation(score, scores) {
            if (scores.length === 0) return 50;
            const mean = scores.reduce((sum, s) => sum + s, 0) / scores.length;
            const variance = scores.reduce((sum, s) => sum + Math.pow(s - mean, 2), 0) / scores.length;
            const standardDeviation = Math.sqrt(variance);
            if (standardDeviation === 0) return 50;
            const deviation = ((score - mean) / standardDeviation) * 10 + 50;
            return Math.round(deviation * 10) / 10;
        }

        function calculateRank(score, scores) {
            const sortedScores = [...scores].sort((a, b) => b - a);
            return sortedScores.findIndex(s => s === score) + 1;
        }

        function calculateScoreRate(score, maxScore) {
            if (maxScore === 0) return 0;
            return Math.round((score / maxScore) * 1000) / 10;
        }

        function calculateSubjectStats(score, maxScore, allScores) {
            const scoreRate = calculateScoreRate(score, maxScore);
            const scoreRates = allScores.map(s => calculateScoreRate(s, maxScore));
            const avgScoreRate = scoreRates.reduce((sum, r) => sum + r, 0) / scoreRates.length;
            const variance = scoreRates.reduce((sum, r) => sum + Math.pow(r - avgScoreRate, 2), 0) / scoreRates.length;
            const stdDev = Math.sqrt(variance);

            return {
                score,
                maxScore,
                scoreRate,
                rank: calculateRank(score, allScores),
                deviation: calculateDeviation(score, allScores),
                averageScoreRate: Math.round(avgScoreRate * 10) / 10,
                scoreRateStdDev: Math.round(stdDev * 10) / 10
            };
        }

        function generateExamResults() {
            const allRequiredScores = rawStudentScores.map(s => s.required);
            const allSubjectScores = {};
            
            subjectNames.forEach(subjectName => {
                allSubjectScores[subjectName] = rawStudentScores.map(s => s[subjectName]);
            });

            return rawStudentScores.map(student => {
                const subjectScores = subjectNames.map(name => student[name]);
                const totalScore = student.required + subjectScores.reduce((sum, s) => sum + s, 0);
                const totalMaxScore = maxScores.required + subjectNames.length * 50;
                const generalScore = subjectScores.reduce((sum, s) => sum + s, 0);
                const generalMaxScore = subjectNames.length * 50;

                const requiredStats = calculateSubjectStats(
                    student.required,
                    maxScores.required,
                    allRequiredScores
                );

                const subjects = {};
                subjectNames.forEach(subjectName => {
                    subjects[subjectName] = calculateSubjectStats(
                        student[subjectName],
                        maxScores[subjectName],
                        allSubjectScores[subjectName] || []
                    );
                });

                return {
                    studentId: student.studentId,
                    studentName: student.studentName,
                    password: student.password,
                    totalScore,
                    totalMaxScore,
                    requiredScore: student.required,
                    requiredMaxScore: maxScores.required,
                    generalScore,
                    generalMaxScore,
                    required: requiredStats,
                    subjects,
                    questionDetails: student.questionDetails || {}
                };
            });
        }

        // 棒グラフコンポーネント
        function BarChart({ scoreRate, averageRate, stdDeviation, label }) {
            const dRate = Math.max(0, averageRate - stdDeviation);
            const aRate = Math.min(100, averageRate + stdDeviation);

            return (
                <div style={{ marginBottom: '15px' }}>
                    <div style={{ marginBottom: '5px', fontWeight: '500', fontSize: '13px' }}>{label}</div>
                    <div style={{ position: 'relative', height: '40px', background: '#e0e0e0', borderRadius: '4px' }}>
                        {/* D範囲（-1σ） */}
                        <div style={{
                            position: 'absolute',
                            left: `${dRate}%`,
                            width: '2px',
                            height: '100%',
                            background: '#FF9800',
                            zIndex: 1
                        }}>
                            <div style={{
                                position: 'absolute',
                                top: '-20px',
                                left: '-10px',
                                fontSize: '10px',
                                color: '#FF9800',
                                fontWeight: 'bold'
                            }}>D</div>
                        </div>
                        
                        {/* 平均 */}
                        <div style={{
                            position: 'absolute',
                            left: `${averageRate}%`,
                            width: '2px',
                            height: '100%',
                            background: '#4CAF50',
                            zIndex: 2
                        }}>
                            <div style={{
                                position: 'absolute',
                                top: '-20px',
                                left: '-12px',
                                fontSize: '10px',
                                color: '#4CAF50',
                                fontWeight: 'bold'
                            }}>平均</div>
                        </div>
                        
                        {/* A範囲（+1σ） */}
                        <div style={{
                            position: 'absolute',
                            left: `${aRate}%`,
                            width: '2px',
                            height: '100%',
                            background: '#F44336',
                            zIndex: 1
                        }}>
                            <div style={{
                                position: 'absolute',
                                top: '-20px',
                                left: '-10px',
                                fontSize: '10px',
                                color: '#F44336',
                                fontWeight: 'bold'
                            }}>A</div>
                        </div>
                        
                        {/* 自分の得点バー */}
                        <div style={{
                            position: 'absolute',
                            left: 0,
                            width: `${scoreRate}%`,
                            height: '100%',
                            background: 'linear-gradient(90deg, #2196F3 0%, #64B5F6 100%)',
                            borderRadius: '4px',
                            transition: 'width 0.5s ease',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'flex-end',
                            paddingRight: '8px',
                            color: 'white',
                            fontWeight: 'bold',
                            fontSize: '14px'
                        }}>
                            {scoreRate > 10 && `${scoreRate.toFixed(1)}%`}
                        </div>
                        
                        {scoreRate <= 10 && (
                            <div style={{
                                position: 'absolute',
                                left: `${scoreRate + 2}%`,
                                top: '50%',
                                transform: 'translateY(-50%)',
                                color: '#2196F3',
                                fontWeight: 'bold',
                                fontSize: '14px'
                            }}>
                                {scoreRate.toFixed(1)}%
                            </div>
                        )}
                    </div>
                    <div style={{ marginTop: '5px', fontSize: '11px', color: '#666', display: 'flex', justifyContent: 'space-between' }}>
                        <span>0%</span>
                        <span style={{ fontSize: '10px' }}>
                            <span style={{ color: '#FF9800' }}>D: {dRate.toFixed(1)}%</span>
                            {' | '}
                            <span style={{ color: '#4CAF50' }}>平均: {averageRate.toFixed(1)}%</span>
                            {' | '}
                            <span style={{ color: '#F44336' }}>A: {aRate.toFixed(1)}%</span>
                        </span>
                        <span>100%</span>
                    </div>
                </div>
            );
        }

        // 問題詳細コンポーネント
        function QuestionDetails({ subjectName, questions }) {
            if (!questions || questions.length === 0) {
                return (
                    <div style={{ padding: '15px', background: '#f5f5f5', borderRadius: '6px', marginTop: '10px' }}>
                        <p style={{ margin: 0, color: '#999' }}>問題詳細データがありません</p>
                    </div>
                );
            }

            return (
                <div style={{ marginTop: '15px' }}>
                    <h5 style={{ marginBottom: '10px' }}>問題別詳細</h5>
                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px', background: 'white', boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                        <thead>
                            <tr style={{ background: '#757575', color: 'white' }}>
                                <th style={{ padding: '8px', textAlign: 'center', borderBottom: '2px solid #ddd' }}>問題番号</th>
                                <th style={{ padding: '8px', textAlign: 'center', borderBottom: '2px solid #ddd' }}>自分の解答</th>
                                <th style={{ padding: '8px', textAlign: 'center', borderBottom: '2px solid #ddd' }}>正答</th>
                                <th style={{ padding: '8px', textAlign: 'center', borderBottom: '2px solid #ddd' }}>結果</th>
                                <th style={{ padding: '8px', textAlign: 'left', borderBottom: '2px solid #ddd' }}>出典</th>
                            </tr>
                        </thead>
                        <tbody>
                            {questions.map((q, index) => {
                                const isCorrect = q.userAnswer === q.correctAnswer;
                                return (
                                    <tr key={index} style={{ background: index % 2 === 0 ? 'white' : '#f9f9f9' }}>
                                        <td style={{ padding: '8px', textAlign: 'center', borderBottom: '1px solid #ddd' }}>
                                            {q.questionNumber}
                                        </td>
                                        <td style={{ 
                                            padding: '8px', 
                                            textAlign: 'center', 
                                            borderBottom: '1px solid #ddd',
                                            fontWeight: 'bold',
                                            color: isCorrect ? '#4CAF50' : '#F44336'
                                        }}>
                                            {q.userAnswer}
                                        </td>
                                        <td style={{ padding: '8px', textAlign: 'center', borderBottom: '1px solid #ddd', fontWeight: 'bold' }}>
                                            {q.correctAnswer}
                                        </td>
                                        <td style={{ padding: '8px', textAlign: 'center', borderBottom: '1px solid #ddd' }}>
                                            <span style={{
                                                padding: '3px 8px',
                                                borderRadius: '3px',
                                                fontSize: '11px',
                                                fontWeight: 'bold',
                                                background: isCorrect ? '#C8E6C9' : '#FFCDD2',
                                                color: isCorrect ? '#2E7D32' : '#C62828'
                                            }}>
                                                {isCorrect ? '○' : '×'}
                                            </span>
                                        </td>
                                        <td style={{ padding: '8px', borderBottom: '1px solid #ddd', fontSize: '12px' }}>
                                            {q.source}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );
        }

        // 全学生一覧表示コンポーネント（教員用）
        function AllStudentsView({ allResults, onSelectStudent }) {
            // 総合点順にソート
            const sortedResults = [...allResults].sort((a, b) => b.totalScore - a.totalScore);

            return (
                <div style={{ padding: '20px', maxWidth: '1400px', margin: '0 auto' }}>
                    <h2 style={{ marginBottom: '20px', color: '#333' }}>全学生成績一覧（総合点順）</h2>
                    
                    <div style={{ overflowX: 'auto' }}>
                        <table style={{ 
                            width: '100%', 
                            borderCollapse: 'collapse', 
                            background: 'white',
                            boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                            fontSize: '13px'
                        }}>
                            <thead>
                                <tr style={{ background: '#1976d2', color: 'white' }}>
                                    <th style={{ padding: '12px', textAlign: 'center', position: 'sticky', left: 0, background: '#1976d2', zIndex: 2 }}>順位</th>
                                    <th style={{ padding: '12px', textAlign: 'left', position: 'sticky', left: '60px', background: '#1976d2', zIndex: 2 }}>学籍番号</th>
                                    <th style={{ padding: '12px', textAlign: 'left' }}>氏名</th>
                                    <th style={{ padding: '12px', textAlign: 'center' }}>総合点</th>
                                    <th style={{ padding: '12px', textAlign: 'center' }}>必修</th>
                                    <th style={{ padding: '12px', textAlign: 'center' }}>解剖学</th>
                                    <th style={{ padding: '12px', textAlign: 'center' }}>生理学</th>
                                    <th style={{ padding: '12px', textAlign: 'center' }}>運動学</th>
                                    <th style={{ padding: '12px', textAlign: 'center' }}>病理学</th>
                                    <th style={{ padding: '12px', textAlign: 'center' }}>衛生学</th>
                                    <th style={{ padding: '12px', textAlign: 'center' }}>リハビリ医学</th>
                                    <th style={{ padding: '12px', textAlign: 'center' }}>一般臨床</th>
                                    <th style={{ padding: '12px', textAlign: 'center' }}>外科学</th>
                                    <th style={{ padding: '12px', textAlign: 'center' }}>整形外科</th>
                                    <th style={{ padding: '12px', textAlign: 'center' }}>柔整理論</th>
                                    <th style={{ padding: '12px', textAlign: 'center' }}>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {sortedResults.map((result, index) => (
                                    <tr key={result.studentId} style={{ 
                                        background: index % 2 === 0 ? 'white' : '#f9f9f9',
                                        transition: 'background 0.2s'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.background = '#e3f2fd'}
                                    onMouseLeave={(e) => e.currentTarget.style.background = index % 2 === 0 ? 'white' : '#f9f9f9'}
                                    >
                                        <td style={{ padding: '10px', textAlign: 'center', fontWeight: 'bold', position: 'sticky', left: 0, background: index % 2 === 0 ? 'white' : '#f9f9f9' }}>
                                            {index + 1}
                                        </td>
                                        <td style={{ padding: '10px', position: 'sticky', left: '60px', background: index % 2 === 0 ? 'white' : '#f9f9f9' }}>
                                            {result.studentId}
                                        </td>
                                        <td style={{ padding: '10px' }}>{result.studentName}</td>
                                        <td style={{ padding: '10px', textAlign: 'center', fontWeight: 'bold', color: '#1976d2' }}>
                                            {result.totalScore}
                                        </td>
                                        <td style={{ padding: '10px', textAlign: 'center' }}>{result.requiredScore}</td>
                                        {subjectNames.map(subjectName => (
                                            <td key={subjectName} style={{ padding: '10px', textAlign: 'center' }}>
                                                {result.subjects[subjectName]?.score || 0}
                                            </td>
                                        ))}
                                        <td style={{ padding: '10px', textAlign: 'center' }}>
                                            <button
                                                onClick={() => onSelectStudent(result.studentId)}
                                                style={{
                                                    padding: '5px 12px',
                                                    fontSize: '12px',
                                                    background: '#1976d2',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '4px',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                詳細
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // 円グラフコンポーネント（削除または非使用）
        function LoginForm({ onLogin }) {
            const [studentId, setStudentId] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                
                // 教員アカウントチェック
                const teacher = teachers.find(t => t.id === studentId && t.password === password);
                if (teacher) {
                    onLogin({ ...teacher, isTeacher: true });
                    setError('');
                    return;
                }
                
                // 学生アカウントチェック
                const allResults = generateExamResults();
                const student = allResults.find(s => s.studentId === studentId && s.password === password);
                
                if (student) {
                    onLogin({ ...student, isTeacher: false });
                    setError('');
                } else {
                    setError('IDまたはパスワードが間違っています');
                }
            };

            return (
                <div style={{ 
                    minHeight: '100vh', 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                }}>
                    <div style={{
                        background: 'white',
                        padding: '40px',
                        borderRadius: '12px',
                        boxShadow: '0 10px 40px rgba(0,0,0,0.2)',
                        width: '100%',
                        maxWidth: '400px'
                    }}>
                        <h1 style={{ 
                            textAlign: 'center', 
                            marginBottom: '30px',
                            color: '#333',
                            fontSize: '24px'
                        }}>
                            模擬試験結果閲覧システム
                        </h1>
                        
                        <form onSubmit={handleSubmit}>
                            <div style={{ marginBottom: '20px' }}>
                                <label style={{ 
                                    display: 'block', 
                                    marginBottom: '8px',
                                    color: '#555',
                                    fontWeight: '500'
                                }}>
                                    ID（学籍番号 or 教員ID）
                                </label>
                                <input
                                    type="text"
                                    value={studentId}
                                    onChange={(e) => setStudentId(e.target.value)}
                                    placeholder="例: S001 または teacher001"
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        fontSize: '16px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '6px',
                                        outline: 'none',
                                        transition: 'border-color 0.3s'
                                    }}
                                    onFocus={(e) => e.target.style.borderColor = '#667eea'}
                                    onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                                    required
                                />
                            </div>
                            
                            <div style={{ marginBottom: '25px' }}>
                                <label style={{ 
                                    display: 'block', 
                                    marginBottom: '8px',
                                    color: '#555',
                                    fontWeight: '500'
                                }}>
                                    パスワード
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="パスワードを入力"
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        fontSize: '16px',
                                        border: '2px solid #e0e0e0',
                                        borderRadius: '6px',
                                        outline: 'none',
                                        transition: 'border-color 0.3s'
                                    }}
                                    onFocus={(e) => e.target.style.borderColor = '#667eea'}
                                    onBlur={(e) => e.target.style.borderColor = '#e0e0e0'}
                                    required
                                />
                            </div>

                            {error && (
                                <div style={{
                                    padding: '12px',
                                    marginBottom: '20px',
                                    background: '#ffebee',
                                    color: '#c62828',
                                    borderRadius: '6px',
                                    fontSize: '14px'
                                }}>
                                    {error}
                                </div>
                            )}
                            
                            <button
                                type="submit"
                                style={{
                                    width: '100%',
                                    padding: '14px',
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    color: 'white',
                                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s'
                                }}
                                onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
                                onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                            >
                                ログイン
                            </button>
                        </form>

                        <div style={{
                            marginTop: '30px',
                            padding: '15px',
                            background: '#f5f5f5',
                            borderRadius: '6px',
                            fontSize: '12px',
                            color: '#666'
                        }}>
                            <strong>デモ用アカウント:</strong><br/>
                            <div style={{ marginTop: '8px' }}>
                                <strong>学生:</strong><br/>
                                ID: S001 〜 S005<br/>
                                パスワード: pass001 〜 pass005
                            </div>
                            <div style={{ marginTop: '8px' }}>
                                <strong>教員（全員分閲覧可）:</strong><br/>
                                ID: teacher001 または admin<br/>
                                パスワード: teacher123 または admin123
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // 円グラフコンポーネント
        function ScoreCircleChart({ scoreRate, averageRate, stdDeviation, size = 120 }) {
            const center = size / 2;
            const radius = (size / 2) - 15;
            const strokeWidth = 8;

            const scoreAngle = (scoreRate / 100) * 360;
            const avgAngle = (averageRate / 100) * 360;
            const dRate = Math.max(0, averageRate - stdDeviation);
            const aRate = Math.min(100, averageRate + stdDeviation);
            const dAngle = (dRate / 100) * 360;
            const aAngle = (aRate / 100) * 360;

            const polarToCartesian = (angle, r) => {
                const radian = ((angle - 90) * Math.PI) / 180;
                return {
                    x: center + r * Math.cos(radian),
                    y: center + r * Math.sin(radian),
                };
            };

            const scorePos = polarToCartesian(scoreAngle, radius);
            const avgPos = polarToCartesian(avgAngle, radius + 10);
            const dPos = polarToCartesian(dAngle, radius + 10);
            const aPos = polarToCartesian(aAngle, radius + 10);

            const describeArc = (startAngle, endAngle) => {
                const start = polarToCartesian(startAngle, radius);
                const end = polarToCartesian(endAngle, radius);
                const largeArcFlag = endAngle - startAngle <= 180 ? '0' : '1';
                return `M ${start.x} ${start.y} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${end.x} ${end.y}`;
            };

            return (
                <svg width={size} height={size} style={{ display: 'block', margin: '0 auto' }}>
                    <circle cx={center} cy={center} r={radius} fill="none" stroke="#e0e0e0" strokeWidth={strokeWidth} />
                    {scoreRate > 0 && (
                        <path d={describeArc(0, scoreAngle)} fill="none" stroke="#2196F3" strokeWidth={strokeWidth} strokeLinecap="round" />
                    )}
                    <circle cx={scorePos.x} cy={scorePos.y} r={6} fill="#2196F3" stroke="white" strokeWidth={2} />
                    <line x1={avgPos.x} y1={avgPos.y} x2={center} y2={center} stroke="#4CAF50" strokeWidth={2} />
                    <text x={avgPos.x} y={avgPos.y} textAnchor="middle" dominantBaseline="middle" fontSize="12" fontWeight="bold" fill="#4CAF50">平均</text>
                    <line x1={dPos.x} y1={dPos.y} x2={center} y2={center} stroke="#FF9800" strokeWidth={2} strokeDasharray="3,3" />
                    <text x={dPos.x} y={dPos.y} textAnchor="middle" dominantBaseline="middle" fontSize="12" fontWeight="bold" fill="#FF9800">D</text>
                    <line x1={aPos.x} y1={aPos.y} x2={center} y2={center} stroke="#F44336" strokeWidth={2} strokeDasharray="3,3" />
                    <text x={aPos.x} y={aPos.y} textAnchor="middle" dominantBaseline="middle" fontSize="12" fontWeight="bold" fill="#F44336">A</text>
                    <text x={center} y={center - 5} textAnchor="middle" dominantBaseline="middle" fontSize="20" fontWeight="bold" fill="#333">{scoreRate.toFixed(1)}%</text>
                    <text x={center} y={10} textAnchor="middle" fontSize="10" fill="#999">0%/100%</text>
                </svg>
            );
        }

        // 結果表示コンポーネント
        function ExamResultView({ user, onLogout }) {
            const allResults = generateExamResults();
            const [selectedStudentId, setSelectedStudentId] = useState(
                user.isTeacher ? allResults[0]?.studentId : user.studentId
            );
            const [viewMode, setViewMode] = useState('detail'); // 'detail' or 'list'
            const [expandedSubject, setExpandedSubject] = useState(null);
            
            // 表示する結果を取得
            const result = user.isTeacher 
                ? allResults.find(r => r.studentId === selectedStudentId)
                : user;

            const handleSelectStudent = (studentId) => {
                setSelectedStudentId(studentId);
                setViewMode('detail');
            };
            const tableHeaderStyle = {
                padding: '12px',
                textAlign: 'left',
                borderBottom: '2px solid #ddd',
            };

            const tableCellStyle = {
                padding: '12px',
                borderBottom: '1px solid #ddd',
            };

            return (
                <div style={{ minHeight: '100vh', background: '#fafafa' }}>
                    <div style={{ background: '#1976d2', color: 'white', padding: '20px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
                        <div style={{ maxWidth: '1400px', margin: '0 auto' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: user.isTeacher ? '15px' : '0' }}>
                                <div>
                                    <h1 style={{ margin: 0 }}>模擬試験結果閲覧システム</h1>
                                    {user.isTeacher && (
                                        <p style={{ margin: '5px 0 0 0', fontSize: '14px', opacity: 0.9 }}>
                                            教員モード: {user.name}
                                        </p>
                                    )}
                                </div>
                                <button
                                    onClick={onLogout}
                                    style={{
                                        padding: '10px 20px',
                                        fontSize: '14px',
                                        color: '#1976d2',
                                        background: 'white',
                                        border: 'none',
                                        borderRadius: '6px',
                                        cursor: 'pointer',
                                        fontWeight: '600'
                                    }}
                                >
                                    ログアウト
                                </button>
                            </div>
                            
                            {user.isTeacher && (
                                <div style={{ display: 'flex', gap: '15px', alignItems: 'center', marginTop: '15px' }}>
                                    <div style={{ display: 'flex', gap: '10px' }}>
                                        <button
                                            onClick={() => setViewMode('list')}
                                            style={{
                                                padding: '8px 16px',
                                                fontSize: '14px',
                                                background: viewMode === 'list' ? 'white' : 'rgba(255,255,255,0.2)',
                                                color: viewMode === 'list' ? '#1976d2' : 'white',
                                                border: 'none',
                                                borderRadius: '4px',
                                                cursor: 'pointer',
                                                fontWeight: '600'
                                            }}
                                        >
                                            全学生一覧
                                        </button>
                                        <button
                                            onClick={() => setViewMode('detail')}
                                            style={{
                                                padding: '8px 16px',
                                                fontSize: '14px',
                                                background: viewMode === 'detail' ? 'white' : 'rgba(255,255,255,0.2)',
                                                color: viewMode === 'detail' ? '#1976d2' : 'white',
                                                border: 'none',
                                                borderRadius: '4px',
                                                cursor: 'pointer',
                                                fontWeight: '600'
                                            }}
                                        >
                                            個別詳細
                                        </button>
                                    </div>
                                    
                                    {viewMode === 'detail' && (
                                        <div>
                                            <label htmlFor="student-select" style={{ marginRight: '10px' }}>
                                                学生選択:
                                            </label>
                                            <select
                                                id="student-select"
                                                value={selectedStudentId}
                                                onChange={(e) => setSelectedStudentId(e.target.value)}
                                                style={{
                                                    padding: '8px 12px',
                                                    fontSize: '16px',
                                                    borderRadius: '4px',
                                                    border: 'none',
                                                    minWidth: '250px',
                                                }}
                                            >
                                                {allResults.map(r => (
                                                    <option key={r.studentId} value={r.studentId}>
                                                        {r.studentId} - {r.studentName}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>

                    {user.isTeacher && viewMode === 'list' ? (
                        <AllStudentsView allResults={allResults} onSelectStudent={handleSelectStudent} />
                    ) : (

                    <div style={{ padding: '20px', maxWidth: '1200px', margin: '0 auto' }}>
                        <h2 style={{ textAlign: 'center', color: '#333', marginBottom: '20px' }}>試験結果</h2>
                        
                        <div style={{ background: '#f5f5f5', padding: '15px', borderRadius: '8px', marginBottom: '20px' }}>
                            <h3 style={{ margin: '0 0 10px 0' }}>学生情報</h3>
                            <p style={{ margin: '5px 0' }}><strong>受験番号:</strong> {result.studentId}</p>
                            <p style={{ margin: '5px 0' }}><strong>氏名:</strong> {result.studentName}</p>
                        </div>

                        <div style={{ background: '#e3f2fd', padding: '15px', borderRadius: '8px', marginBottom: '20px' }}>
                            <h3 style={{ margin: '0 0 10px 0' }}>総合成績</h3>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '15px' }}>
                                <div><strong>総合点:</strong> {result.totalScore}/{result.totalMaxScore}</div>
                                <div><strong>必修:</strong> {result.requiredScore}/{result.requiredMaxScore}</div>
                                <div><strong>一般合計:</strong> {result.generalScore}/{result.generalMaxScore}</div>
                            </div>
                        </div>

                        <div style={{ marginBottom: '20px' }}>
                            <h3>必修</h3>
                            <div style={{ background: 'white', padding: '20px', borderRadius: '8px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)' }}>
                                <BarChart
                                    scoreRate={result.required.scoreRate}
                                    averageRate={result.required.averageScoreRate}
                                    stdDeviation={result.required.scoreRateStdDev}
                                    label="必修得点率"
                                />
                                <div style={{ marginTop: '15px', display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '10px', fontSize: '13px' }}>
                                    <div><strong>得点:</strong> {result.required.score}/{result.required.maxScore}</div>
                                    <div><strong>得点率:</strong> {result.required.scoreRate}%</div>
                                    <div><strong>順位:</strong> {result.required.rank}位</div>
                                    <div><strong>偏差値:</strong> {result.required.deviation}</div>
                                </div>
                                
                                {result.questionDetails?.['必修'] && (
                                    <QuestionDetails subjectName="必修" questions={result.questionDetails['必修']} />
                                )}
                            </div>
                        </div>

                        <div>
                            <h3>科目別成績</h3>
                            <table style={{ width: '100%', borderCollapse: 'collapse', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', marginBottom: '30px', background: 'white' }}>
                                <thead>
                                    <tr style={{ background: '#1976d2', color: 'white' }}>
                                        <th style={tableHeaderStyle}>科目</th>
                                        <th style={tableHeaderStyle}>得点</th>
                                        <th style={tableHeaderStyle}>得点率</th>
                                        <th style={tableHeaderStyle}>順位</th>
                                        <th style={tableHeaderStyle}>偏差値</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {subjectNames.map((subjectName, index) => {
                                        const subject = result.subjects[subjectName];
                                        if (!subject) return null;
                                        
                                        return (
                                            <tr key={subjectName} style={{ background: index % 2 === 0 ? 'white' : '#f9f9f9' }}>
                                                <td style={tableCellStyle}><strong>{subjectName}</strong></td>
                                                <td style={tableCellStyle}>{subject.score}/{subject.maxScore}</td>
                                                <td style={tableCellStyle}>{subject.scoreRate}%</td>
                                                <td style={tableCellStyle}>{subject.rank}位</td>
                                                <td style={tableCellStyle}>{subject.deviation}</td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>

                            <h4 style={{ marginBottom: '20px' }}>科目別得点率（棒グラフ）</h4>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: '20px', marginBottom: '20px' }}>
                                {subjectNames.map((subjectName) => {
                                    const subject = result.subjects[subjectName];
                                    if (!subject) return null;
                                    const isExpanded = expandedSubject === subjectName;
                                    
                                    return (
                                        <div key={subjectName} style={{ background: 'white', padding: '15px', borderRadius: '8px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
                                                <h5 style={{ margin: 0, color: '#333' }}>{subjectName}</h5>
                                                {result.questionDetails?.[subjectName]?.length > 0 && (
                                                    <button
                                                        onClick={() => setExpandedSubject(isExpanded ? null : subjectName)}
                                                        style={{
                                                            padding: '4px 10px',
                                                            fontSize: '11px',
                                                            background: isExpanded ? '#1976d2' : '#e0e0e0',
                                                            color: isExpanded ? 'white' : '#333',
                                                            border: 'none',
                                                            borderRadius: '3px',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        {isExpanded ? '問題を閉じる' : '問題詳細'}
                                                    </button>
                                                )}
                                            </div>
                                            
                                            <BarChart
                                                scoreRate={subject.scoreRate}
                                                averageRate={subject.averageScoreRate}
                                                stdDeviation={subject.scoreRateStdDev}
                                                label=""
                                            />
                                            
                                            <div style={{ marginTop: '10px', fontSize: '12px', display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px' }}>
                                                <div><strong>得点:</strong> {subject.score}/{subject.maxScore}</div>
                                                <div><strong>順位:</strong> {subject.rank}位</div>
                                                <div><strong>得点率:</strong> {subject.scoreRate}%</div>
                                                <div><strong>偏差値:</strong> {subject.deviation}</div>
                                            </div>
                                            
                                            {isExpanded && result.questionDetails?.[subjectName] && (
                                                <QuestionDetails 
                                                    subjectName={subjectName} 
                                                    questions={result.questionDetails[subjectName]} 
                                                />
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                )}
                </div>
            );
        }

        // メインアプリ
        function App() {
            const [loggedInUser, setLoggedInUser] = useState(null);

            const handleLogin = (user) => {
                setLoggedInUser(user);
            };

            const handleLogout = () => {
                setLoggedInUser(null);
            };

            if (!loggedInUser) {
                return <LoginForm onLogin={handleLogin} />;
            }

            return <ExamResultView user={loggedInUser} onLogout={handleLogout} />;
        }

        // レンダリング
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
